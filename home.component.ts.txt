import { Component } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { FormGroup, FormArray, FormControl, Validators } from '@angular/forms';

@Component({
  selector: 'app-home',
  templateUrl: './home.component.html',
  styleUrls: ['./home.component.scss']
})
export class HomeComponent {

  width = new FormControl('', Validators.required);
  height = new FormControl('', Validators.required);
  hlines = new FormControl('', Validators.required);
  vlines = new FormControl('', Validators.required);

  otherDataForm: any = new FormGroup({
    width: this.width,
    height: this.height,
    hlines: this.hlines,
    ingredients: new FormArray([]),
    vlines: new FormArray([])
  });

  constructor(private http: HttpClient) { }

  onSubmit() {
    let hlinesArray = this.otherDataForm.get('ingredients') as FormArray;
    let hlines = Number(this.hlines.value);

    for (let i = 0; i < hlines; i++) {
      let hgap = new FormControl('', Validators.required);
      hlinesArray.push(hgap);
    }

    let vlinesArray = this.otherDataForm.get('vlines') as FormArray;
    let vlines = Number(this.vlines.value);

    for (let j = 0; j < vlines; j++) {
      let vgap = new FormControl('', Validators.required);
      vlinesArray.push(vgap);
    }

    this.drawRectangle(
      Number(this.width.value),
      Number(this.height.value),
      Number(this.hlines.value),
      Number(this.vlines.value)
    );

    let data = {
      width: Number(this.width.value),
      height: Number(this.height.value),
      hgap: this.otherDataForm.get('ingredients').value,
      vgap: this.otherDataForm.get('vlines').value,
    };

    this.http.post('server_url', data).subscribe(
      response => {
        console.log(response);
      },
      error => {
        console.error(error);
      }
    );
  }

  drawRectangle(width: number | null, height: number | null, hlines: number | null, vlines: number | null) {
    if (width == null || height == null || hlines == null || vlines == null) return;

    let canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;

    let ctx = canvas.getContext('2d');

    ctx?.strokeRect(0, 0, width, height);

    let hlinesArray = this.otherDataForm.get('ingredients') as FormArray;
    for (let i = 0; i < hlinesArray.length; i++) {
      let y = Number(hlinesArray.controls[i].value);
      ctx?.moveTo(0, y);
      ctx?.lineTo(width, y);
      ctx?.stroke();
    }

    let vlinesArray = this.otherDataForm.get('vlines') as FormArray;
    for (let j = 0; j < vlinesArray.length; j++) {
      let x = Number(vlinesArray.controls[j].value);
      ctx?.moveTo(x, 0);
      ctx?.lineTo(x, height);
      ctx?.stroke();
    }

    document.body.appendChild(canvas);
  }
}
